<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthScan - Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root { --color-primary: 0, 180, 180; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .app-card { background-color: #ffffff; border: 1px solid #e2e8f0; }
        .btn-primary { background-color: rgb(var(--color-primary)); transition: all 0.2s ease; }
        .btn-primary:hover { background-color: rgb(0, 150, 150); transform: translateY(-1px); }
        .spinner { border-top-color: rgb(var(--color-primary)); border-right-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #resultDisease { font-size: 1rem; line-height: 1.7; color: #334155; }
        #resultDisease h3 { font-size: 1.4rem; font-weight: 800; color: #0f172a; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        #resultDisease hr { margin: 1.25rem 0; border: 0; border-top: 1px solid #e2e8f0; }
        #resultDisease ul { list-style-type: none; padding-left: 0; margin: 1rem 0; }
        #resultDisease li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        #resultDisease li::before { content: "â€¢"; position: absolute; left: 0.25rem; color: rgb(0, 180, 180); font-weight: bold; }
        
        .error-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 4px; height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            margin: 0 1px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="antialiased text-slate-900">

    <div class="min-h-screen p-4 md:p-8 flex justify-center items-center">
        <div id="app-card" class="app-card max-w-6xl w-full rounded-[2.5rem] shadow-xl p-6 md:p-10 flex flex-col lg:flex-row gap-10">

            <!-- Left Panel -->
            <div class="lg:w-5/12 space-y-8">
                <header class="flex items-center space-x-3 border-b pb-6">
                    <div class="bg-teal-600 p-2 rounded-xl text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
                    </div>
                    <h1 class="text-2xl font-black tracking-tight text-slate-800">HealthScan Hub</h1>
                </header>

                <div class="space-y-6">
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Phone Number (Required)</label>
                            <input type="tel" id="phoneNumberInput" placeholder="Enter number for session ID..." class="w-full p-4 border border-slate-200 rounded-2xl outline-none bg-slate-50 transition-all focus:border-teal-500">
                            <p id="phoneError" class="hidden text-[10px] text-red-500 font-bold mt-1">Phone Number is needed to link AI memory.</p>
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold uppercase tracking-wider text-slate-400">Symptoms</label>
                            <textarea id="symptomInput" rows="5" placeholder="Detail your symptoms..." class="w-full p-4 border border-slate-200 rounded-2xl outline-none bg-slate-50 resize-none transition-all focus:border-teal-500"></textarea>
                        </div>
                    </div>
                    <button id="checkButton" class="btn-primary w-full p-4 font-bold text-white rounded-2xl shadow-lg">Generate Medical Report</button>
                </div>

                <div class="bg-slate-900 rounded-2xl p-4 overflow-hidden shadow-inner">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Live Deployment Status</span>
                        <div class="flex items-center space-x-2">
                            <div id="modeIndicator" class="w-2 h-2 rounded-full bg-emerald-500 shadow-sm shadow-emerald-500/50"></div>
                            <span id="modeText" class="text-[9px] text-slate-400 font-bold uppercase">Production Mode</span>
                        </div>
                    </div>
                    <div id="debugLog" class="text-[11px] font-mono text-emerald-400 max-h-32 overflow-y-auto leading-relaxed">System Live. Ready for GitHub deployment.</div>
                    <div class="flex justify-end mt-2">
                        <button id="clearLogBtn" class="text-[10px] text-teal-500 font-bold uppercase hover:text-white">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="lg:w-7/12 bg-slate-50 rounded-[2rem] p-6 md:p-10 flex flex-col border border-slate-100">
                <div class="flex items-center space-x-2 mb-8">
                    <div class="w-1 h-6 bg-teal-500 rounded-full"></div>
                    <h2 class="text-xl font-bold text-slate-800 uppercase tracking-tight">AI Agent Analysis</h2>
                </div>

                <div id="initialState" class="flex-grow flex flex-col items-center justify-center text-center space-y-4 text-slate-400">
                    <p class="italic text-sm">Enter phone and symptoms to trigger the Agents.</p>
                </div>

                <div id="loadingState" class="hidden flex-grow flex flex-col items-center justify-center text-center space-y-4">
                    <div class="spinner w-12 h-12 border-4 rounded-full"></div>
                    <p class="text-teal-600 font-bold text-xs animate-pulse uppercase tracking-widest">Agent is creating report...</p>
                </div>

                <div id="resultsState" class="hidden flex-grow animate-in fade-in zoom-in duration-300">
                    <div class="bg-white p-8 rounded-3xl shadow-xl border border-teal-50 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-teal-50 rounded-bl-full -mr-12 -mt-12 opacity-50"></div>
                        <div id="resultDisease"></div>
                        <div class="mt-8 pt-6 border-t border-slate-50 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Active Session ID</p>
                                <p id="resultPhone" class="text-sm font-bold text-slate-700">...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="openChatButton" class="w-full p-4 bg-slate-900 text-white font-bold rounded-2xl flex items-center justify-center space-x-2 hover:bg-slate-800 transition-all shadow-lg">
                        <svg class="w-5 h-5 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 00-2 2z"></path></svg>
                        <span>Book an Appointment</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom UI Chatbot -->
    <div id="chatbotContainer" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="w-80 h-[32rem] bg-white rounded-3xl shadow-2xl flex flex-col border border-slate-100 overflow-hidden shadow-2xl animate-in slide-in-from-bottom-5 duration-300">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
                <div class="flex items-center space-x-2">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="text-xs font-bold uppercase tracking-widest">Booking AI Assistant</span>
                </div>
                <button id="closeChatButton" class="text-slate-400 hover:text-white transition-all">
                    <svg class="w-5 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="chatMessages" class="flex-grow p-4 space-y-3 overflow-y-auto bg-slate-50 text-sm scroll-smooth"></div>

            <div id="agentTypingStatus" class="hidden px-4 py-2 bg-slate-50 text-[10px] text-slate-400 italic">
                <div class="typing-indicator">Agent is thinking<span></span><span></span><span></span></div>
            </div>

            <div class="p-4 bg-white border-t border-slate-100 flex space-x-2">
                <input type="text" id="chatInput" placeholder="Enter message..." class="flex-grow p-3 text-sm border border-slate-200 rounded-xl bg-slate-50 outline-none focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all">
                <button id="chatSendButton" class="bg-teal-500 text-white px-4 rounded-xl font-bold text-sm hover:bg-teal-600 shadow-md">Send</button>
            </div>
        </div>
    </div>

    <script type="module">
        /**
         * GITHUB DEPLOYMENT CONFIGURATION
         * Ensure your n8n workflow is toggled to "ACTIVE".
         */
        const PRODUCTION_MODE = true; 
        const PROD_URL = 'https://xzen.app.n8n.cloud/webhook/chat';
        const TEST_URL = 'https://xzen.app.n8n.cloud/webhook-test/chat';
        
        const WEBHOOK_URL = PRODUCTION_MODE ? PROD_URL : TEST_URL;

        const els = {
            phone: document.getElementById('phoneNumberInput'),
            phoneErr: document.getElementById('phoneError'),
            symp: document.getElementById('symptomInput'),
            btn: document.getElementById('checkButton'),
            init: document.getElementById('initialState'),
            load: document.getElementById('loadingState'),
            res: document.getElementById('resultsState'),
            resDisease: document.getElementById('resultDisease'),
            resPhone: document.getElementById('resultPhone'),
            chat: document.getElementById('chatbotContainer'),
            chatMsg: document.getElementById('chatMessages'),
            debug: document.getElementById('debugLog'),
            clearLog: document.getElementById('clearLogBtn'),
            typing: document.getElementById('agentTypingStatus'),
            input: document.getElementById('chatInput'),
            modeIndicator: document.getElementById('modeIndicator'),
            modeText: document.getElementById('modeText')
        };

        // Update UI based on mode
        if (PRODUCTION_MODE) {
            els.modeIndicator.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-sm shadow-emerald-500/50";
            els.modeText.textContent = "Production Mode";
        }

        function log(msg, color = '#10b981') {
            const d = document.createElement('div');
            d.style.color = color;
            d.innerHTML = `> ${msg}`;
            els.debug.appendChild(d);
            els.debug.scrollTop = els.debug.scrollHeight;
        }

        function validatePhone() {
            const val = els.phone.value.trim();
            if (!val) {
                els.phone.classList.add('error-shake');
                els.phoneErr.classList.remove('hidden');
                setTimeout(() => els.phone.classList.remove('error-shake'), 500);
                return null;
            }
            els.phoneErr.classList.add('hidden');
            return val;
        }

        async function triggerWorkflow(payload, callback) {
            log(`Transmitting: ${payload.type}`);
            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error("Connection failed. Ensure n8n workflow is ACTIVE.");
                }
                
                const raw = await response.text();
                let data;
                try { data = JSON.parse(raw); } catch(e) { data = { output: raw }; }
                callback(Array.isArray(data) ? data[0] : data);
            } catch (err) {
                log(`FAIL: ${err.message}`, "#f87171");
                els.load.classList.add('hidden');
                els.init.classList.remove('hidden');
                els.btn.disabled = false;
                els.typing.classList.add('hidden');
            }
        }

        els.btn.onclick = () => {
            const p = validatePhone();
            const s = els.symp.value.trim();
            if (!p || !s) return;

            els.btn.disabled = true;
            els.init.classList.add('hidden');
            els.load.classList.remove('hidden');
            els.res.classList.add('hidden');
            
            triggerWorkflow({ 
                phone: p, symptoms: s, type: 'diagnostic_report', sessionId: p,
                message: s, chatInput: s
            }, (data) => {
                const item = data;
                let html = (item.json ? item.json.output : (item.output || item.message || (typeof item === 'string' ? item : "Empty Report")));
                if (html.startsWith('h3>')) html = '<' + html;
                els.resDisease.innerHTML = html.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
                els.resPhone.textContent = item.phone || p;
                els.load.classList.add('hidden');
                els.res.classList.remove('hidden');
                els.btn.disabled = false;
                log("Report Received.");
            });
        };

        async function sendChat(text, isAuto = false) {
            const p = validatePhone();
            if (!p) return;
            
            if (!isAuto) {
                const u = document.createElement('div');
                u.className = "bg-slate-900 text-white p-3 rounded-2xl rounded-tr-none ml-auto max-w-[85%] animate-in slide-in-from-right-5 shadow-sm";
                u.textContent = text;
                els.chatMsg.appendChild(u);
                els.chatMsg.scrollTop = els.chatMsg.scrollHeight;
            }

            els.typing.classList.remove('hidden');

            triggerWorkflow({ 
                chatInput: text, message: text, type: 'appointment_booking', 
                phone: p, sessionId: p 
            }, (data) => {
                els.typing.classList.add('hidden');
                const item = data;
                
                let resp = "";
                if (item.json && item.json.output) resp = item.json.output;
                else if (item.output) resp = item.output;
                else if (item.message) resp = item.message;
                else if (typeof item === 'string') resp = item;
                else resp = "Agent response confirmed.";

                const b = document.createElement('div');
                b.className = "bg-white p-3 rounded-2xl rounded-tl-none text-slate-700 shadow-sm border border-slate-100 leading-relaxed animate-in slide-in-from-left-5";
                b.innerHTML = resp;
                els.chatMsg.appendChild(b);
                els.chatMsg.scrollTop = els.chatMsg.scrollHeight;
                els.input.focus();
                log("Agent Replied.");
            });
        }

        document.getElementById('openChatButton').onclick = () => {
            if (!validatePhone()) return;
            els.chat.classList.remove('hidden');
            if (els.chatMsg.children.length === 0) {
                const ctx = els.resDisease.innerText || "New Entry";
                sendChat(`Patient Info Context: ${ctx.substring(0, 100)}...`, true);
            }
        };

        document.getElementById('closeChatButton').onclick = () => els.chat.classList.add('hidden');
        const submit = () => { if (els.input.value.trim()) { sendChat(els.input.value.trim()); els.input.value = ''; } };
        document.getElementById('chatSendButton').onclick = submit;
        els.input.onkeypress = (e) => { if (e.key === 'Enter') submit(); };
        els.clearLog.onclick = () => els.debug.innerHTML = 'Logs cleared.';
    </script>
</body>
</html>
