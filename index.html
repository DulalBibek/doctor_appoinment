<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symptom Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: 0, 180, 180; /* Teal */
            --color-secondary: 59, 130, 246; /* Blue */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f8ff; /* Slightly whiter, clinical light blue */
        }
        .app-card {
            background-color: rgba(255, 255, 255, 0.95); /* Near-transparent white */
            backdrop-filter: blur(5px);
            border: 1px solid #d1eaff;
        }
        .btn-primary {
            background-color: rgb(var(--color-primary));
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: rgb(0, 150, 150);
        }
        /* Custom spinner for loading state */
        .spinner {
            border-top-color: rgb(var(--color-primary));
            border-right-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Added for the new DNA/Scan icon animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.05); }
        }
        .animate-pulse-subtle {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="antialiased">

    <!-- NEW: Medical Vibe Background Overlay (Large, Faint Symbol) -->
    <div class="fixed inset-0 flex items-center justify-center opacity-5 pointer-events-none">
        <!-- Large Stylized Medical Cross (SVG) -->
        <svg class="w-1/2 h-full text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <!-- A bolder, medical-looking cross symbol, taking up a large space -->
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="0.5" d="M12 4v16m8-8H4"></path>
        </svg>
    </div>
    
    <!-- Main Container - Z-index is raised so it appears above the background symbol -->
    <!-- REFINEMENT: Changed p-4 md:p-12 to p-4 sm:p-6 md:p-12 for better mobile spacing -->
    <div class="min-h-screen p-4 sm:p-6 md:p-12 flex justify-center items-center relative z-10">
        <!-- App Card: Responsive and subtly transparent -->
        <div id="app-card" class="app-card max-w-6xl w-full rounded-3xl shadow-2xl p-6 md:p-10 flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-10">

            <!-- Left Panel: Input & Actions -->
            <div class="lg:w-1/2 space-y-8">
                
                <!-- Header with Medical Sign -->
                <header class="flex items-center space-x-3 text-gray-800 border-b pb-4 mb-4">
                    <!-- Medical Sign (Stylized Heart/Cross) -->
                    <svg class="w-10 h-10 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-.318-.318M20 12h-2m2 0v2m-4-2h-2m-2-4v2m-2-2h-2m-2 4h-2m0 0a1 1 0 100 2 1 1 0 000-2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18v-6h4"></path>
                    </svg>
                    <h1 class="text-3xl font-extrabold tracking-tight">
                        <span class="text-teal-600">Health</span><span class="text-gray-900">Scan</span>
                    </h1>
                </header>

                <!-- Input Prompt Section -->
                <section class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">1. Describe Your Symptoms</h2>
                    <p class="text-gray-500">Please provide a detailed description of your current symptoms, how long they've lasted, and any relevant medical history.</p>

                    <textarea id="symptomInput" rows="5" placeholder="E.g., I have had a dull headache and a slight fever of 100.5Â°F for the past 24 hours. I also feel dizzy when standing up quickly." 
                        class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition duration-150 resize-none text-gray-700 shadow-sm"></textarea>
                    
                    <button id="checkButton" class="btn-primary w-full p-3 font-bold text-white rounded-xl shadow-lg shadow-teal-300/50 flex items-center justify-center space-x-2 transition transform hover:scale-[1.01] active:scale-[0.99] disabled:bg-gray-400 disabled:shadow-none">
                        <!-- UPDATED ICON: Now represents data/analysis/science -->
                        <svg id="buttonIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V7h-2"></path>
                        </svg>
                        <span id="buttonText">Analyze Symptoms</span>
                    </button>

                    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl relative" role="alert">
                        <strong class="font-bold">Input Required:</strong>
                        <span class="block sm:inline">Please enter your symptoms before checking.</span>
                    </div>

                </section>
                
                <!-- Disclaimer -->
                <footer class="mt-8 pt-4 border-t border-gray-200">
                    <p class="text-xs text-gray-400 italic">
                        Disclaimer: This application provides preliminary information and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of a physician or other qualified health provider.
                    </p>
                </footer>
            </div>

            <!-- Right Panel: Results, Loading, and History -->
            <div class="lg:w-1/2 bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-inner space-y-6">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-3">2. Analysis Results</h2>

                <!-- Initial State / Placeholder - More clinical/data vibe -->
                <div id="initialState" class="text-center p-12 space-y-4 text-gray-500">
                    <!-- New icon: DNA helix / Scan icon with subtle pulse animation -->
                    <svg class="w-16 h-16 mx-auto text-teal-300 animate-pulse-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.75 7.75a4 4 0 00-.707 5.707l1.414 1.414a4 4 0 005.657 0m0-8.485a4 4 0 00-5.657 0l-1.414 1.414a4 4 0 000 5.657m13.414-5.657l-1.414 1.414a4 4 0 00-5.657 0m0 8.485l1.414-1.414a4 4 0 005.657 0"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h.01M15 12h.01"></path>
                    </svg>
                    <p class="text-lg font-medium text-gray-600">Awaiting Clinical Data Input</p>
                    <p class="text-sm text-gray-500">Your symptoms will be cross-referenced against global health datasets here.</p>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="hidden text-center p-12 space-y-4">
                    <div class="spinner w-10 h-10 border-4 rounded-full mx-auto"></div>
                    <p class="text-teal-600 font-medium">Analyzing over 10,000 potential conditions...</p>
                    <p class="text-sm text-gray-500">This may take a moment while our AI cross-references your input.</p>
                </div>

                <!-- Results State -->
                <div id="resultsState" class="hidden space-y-6">
                    <h3 class="text-2xl font-bold text-teal-600 border-b pb-3 flex items-center space-x-2">
                         <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        Preliminary Assessment
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- Result Item: Condition -->
                        <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-teal-500">
                            <p class="text-sm text-gray-500 font-medium">Most Probable Condition</p>
                            <p id="resultCondition" class="text-xl font-bold text-gray-800">Common Cold (Viral Rhinitis)</p>
                        </div>

                        <!-- Result Item: Confidence -->
                        <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500">
                            <p class="text-sm text-gray-500 font-medium">Confidence Score</p>
                            <p class="text-xl font-bold text-gray-800 flex items-center">
                                <span id="resultConfidence">92%</span>
                                <span class="ml-4 text-sm font-normal text-green-500 bg-green-50 p-1 rounded-full px-3">High Match</span>
                            </p>
                        </div>
                        
                        <!-- Result Item: Urgency -->
                        <div id="urgencyCard" class="bg-white p-4 rounded-xl shadow-md border-l-4 border-green-500">
                            <p class="text-sm text-gray-500 font-medium">Suggested Urgency Level</p>
                            <p id="resultUrgency" class="text-xl font-bold text-green-600">Self-Care / Monitor</p>
                            <p class="text-sm text-gray-600 mt-1">Symptom profile suggests a non-emergency condition. Rest and hydration recommended.</p>
                        </div>
                    </div>
                </div>

                <!-- Suggestions/Next Steps -->
                <div id="suggestions" class="hidden border-t pt-4 mt-6 space-y-3">
                    <h4 class="font-semibold text-gray-700">Next Steps:</h4>
                    <ul class="list-disc pl-5 text-gray-600 space-y-1 text-sm">
                        <li>Consult a doctor to confirm the diagnosis and receive personalized treatment.</li>
                        <li>Track symptom changes daily. If symptoms worsen, seek immediate medical attention.</li>
                        <li>For emergency advice, call your local emergency number.</li>
                    </ul>
                </div>

                <!-- NEW: Doctor Appointment Section -->
                <div id="appointmentSection" class="mt-8 pt-6 border-t border-teal-200 space-y-4 bg-teal-50 p-6 rounded-2xl">
                    <h2 class="text-xl font-bold text-teal-800 flex items-center space-x-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        3. Book an Appointment
                    </h2>
                    <p class="text-sm text-teal-700">Ready to consult a professional? Seamlessly schedule a tele-health or in-person visit with a specialist based on your analysis.</p>
                    
                    <button id="openChatButton" class="btn-primary w-full p-3 font-bold text-white rounded-xl shadow-lg shadow-teal-500/50 flex items-center justify-center space-x-2 transition transform hover:scale-[1.01] active:scale-[0.99]">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span>Find Available Doctors</span>
                    </button>
                </div>
                <!-- End Appointment Section -->


            </div>
            
        </div>
    </div>

    <!-- NEW: Chatbot Modal/Floating Window -->
    <!-- REFINEMENT: Changed fixed bottom-4 right-4 to fixed bottom-4 right-4 sm:right-6 lg:right-12 to maintain spacing on different screens -->
    <div id="chatbotContainer" class="fixed bottom-4 right-4 sm:right-6 lg:right-12 z-50 hidden">
        <div class="w-80 h-[400px] bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden border border-teal-200">
            <!-- Header -->
            <div class="bg-teal-600 p-3 flex justify-between items-center text-white">
                <div class="font-bold flex items-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z"></path></svg>
                    <span>Appointment Assistant</span>
                </div>
                <button id="closeChatButton" class="text-white hover:text-teal-200 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Messages Area -->
            <div id="chatMessages" class="flex-grow p-3 space-y-3 overflow-y-auto bg-gray-50">
                <!-- Initial Bot Message -->
                <div class="flex justify-start">
                    <div class="bg-teal-200 text-teal-900 p-2 rounded-lg max-w-[80%] shadow-sm">
                        Hello! I'm your Appointment Assistant. How can I help you book a specialist today?
                    </div>
                </div>
                <!-- Messages will be injected here -->
            </div>
            
            <!-- Input Area -->
            <div class="p-3 border-t flex space-x-2">
                <input type="text" id="chatInput" placeholder="Ask about availability..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 text-sm">
                <button id="chatSendButton" class="bg-teal-500 text-white p-2 rounded-lg hover:bg-teal-600 transition disabled:bg-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript for UI/State Management (Reverted to Mock) -->
    <script type="module">
        // --- Firebase Initialization (Required Structure) ---
        // These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        // FIX: Corrected typo from __initialAuthToken to __initial_auth_token
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        
        // IMPORTANT: REPLACE THIS PLACEHOLDER WITH YOUR N8N WEBHOOK URL
        const N8N_CHAT_WEBHOOK_URL = 'YOUR_N8N_APPOINTMENT_WEBHOOK_URL_HERE'; 

        // Mock result data for demonstration (used by startCheck)
        const mockResult = {
            condition: "Migraine Headache",
            confidence: "78%",
            urgency: "Consult a Doctor Today",
            urgencyLevel: "urgent", // 'urgent', 'normal', 'low'
            description: "Based on the reported symptoms (severe throbbing pain, sensitivity to light/sound), this is the most likely preliminary diagnosis. Please consult a neurologist or general practitioner."
        };

        const mockResult2 = {
            condition: "Muscle Strain (Tension)",
            confidence: "95%",
            urgency: "Self-Care / Monitor",
            urgencyLevel: "low",
            description: "Symptom profile suggests a non-emergency condition. Rest, ice, and over-the-counter pain relievers recommended."
        };

        let currentMock = 1;


        // Function definitions are placed outside initApp so they can be referenced globally if needed
        function updateUrgencyStyle(level) {
            const urgencyCard = document.getElementById('urgencyCard');
            urgencyCard.classList.remove('border-green-500', 'border-yellow-500', 'border-red-500');
            document.getElementById('resultUrgency').classList.remove('text-green-600', 'text-yellow-700', 'text-red-700');
            
            if (level === 'low') {
                urgencyCard.classList.add('border-green-500');
                document.getElementById('resultUrgency').classList.add('text-green-600');
            } else if (level === 'urgent') {
                urgencyCard.classList.add('border-yellow-500');
                document.getElementById('resultUrgency').classList.add('text-yellow-700');
            } else if (level === 'emergency') {
                urgencyCard.classList.add('border-red-500');
                document.getElementById('resultUrgency').classList.add('text-red-700');
            }
        }

        function displayResults(result) {
            const initialState = document.getElementById('initialState');
            const loadingState = document.getElementById('loadingState');
            const resultsState = document.getElementById('resultsState');
            const suggestions = document.getElementById('suggestions');
            const appointmentSection = document.getElementById('appointmentSection');

            document.getElementById('resultCondition').textContent = result.condition;
            document.getElementById('resultConfidence').textContent = result.confidence;
            document.getElementById('resultUrgency').textContent = result.urgency;
            document.getElementById('urgencyCard').querySelector('p:last-child').textContent = result.description;

            updateUrgencyStyle(result.urgencyLevel);

            initialState.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultsState.classList.remove('hidden');
            suggestions.classList.remove('hidden');
            appointmentSection.classList.remove('hidden'); 
        }

        // Symptom Check function (MOCK)
        function startCheck() {
            const symptomInput = document.getElementById('symptomInput');
            const checkButton = document.getElementById('checkButton');
            const buttonText = document.getElementById('buttonText');
            const buttonIcon = document.getElementById('buttonIcon');
            const errorMessage = document.getElementById('errorMessage');
            const initialState = document.getElementById('initialState');
            const loadingState = document.getElementById('loadingState');
            const resultsState = document.getElementById('resultsState');
            const suggestions = document.getElementById('suggestions');
            const appointmentSection = document.getElementById('appointmentSection');

            errorMessage.classList.add('hidden');
            const symptomText = symptomInput.value.trim();
            
            if (symptomText.length < 10) {
                errorMessage.classList.remove('hidden');
                return;
            }

            // Enter Loading State
            checkButton.disabled = true;
            checkButton.classList.add('bg-gray-400');
            buttonText.textContent = 'Analyzing...';
            buttonIcon.innerHTML = `<div class="spinner w-5 h-5 border-2 rounded-full"></div>`;
            
            initialState.classList.add('hidden');
            resultsState.classList.add('hidden');
            suggestions.classList.add('hidden');
            appointmentSection.classList.add('hidden'); 
            loadingState.classList.remove('hidden');

            // Simulate API latency
            setTimeout(() => {
                const resultToUse = currentMock === 1 ? mockResult : mockResult2;
                displayResults(resultToUse);
                
                currentMock = currentMock === 1 ? 2 : 1;

                // Return to normal button state
                checkButton.disabled = false;
                checkButton.classList.remove('bg-gray-400');
                buttonText.textContent = 'Analyze Symptoms';
                buttonIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V7h-2"></path>`;

            }, 2500); 
        }

        // NEW: Chatbot Functions
        function openChatbot() {
            const chatbotContainer = document.getElementById('chatbotContainer');
            const openChatButton = document.getElementById('openChatButton');
            const chatInput = document.getElementById('chatInput');

            chatbotContainer.classList.remove('hidden');
            openChatButton.classList.add('hidden');
            chatInput.focus();
        }

        function closeChatbot() {
            const chatbotContainer = document.getElementById('chatbotContainer');
            const openChatButton = document.getElementById('openChatButton');

            chatbotContainer.classList.add('hidden');
            openChatButton.classList.remove('hidden');
        }

        function addMessage(text, sender) {
            const chatMessages = document.getElementById('chatMessages');

            const msgDiv = document.createElement('div');
            msgDiv.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = sender === 'user' 
                ? 'bg-blue-500 text-white p-2 rounded-lg max-w-[80%] shadow-md' 
                : 'bg-teal-200 text-teal-900 p-2 rounded-lg max-w-[80%] shadow-sm';
            contentDiv.textContent = text;
            
            msgDiv.appendChild(contentDiv);
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatMessages = document.getElementById('chatMessages');
            
            const message = chatInput.value.trim();
            if (message === '') return;

            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendButton.disabled = true;

            // Placeholder for bot response/loading state
            addMessage("...", 'bot');
            chatMessages.lastChild.querySelector('div').textContent = 'Assistant is checking availability...';

            try {
                // Connection to N8N Webhook for Appointment System
                const response = await fetch(N8N_CHAT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                // Assumes n8n returns a JSON with a 'response' or 'message' field
                const botResponse = data.response || data.message || "I received your request! A specialist will contact you to confirm the appointment details.";
                
                // Update the loading message with the real bot response
                chatMessages.lastChild.querySelector('div').textContent = botResponse;

            } catch (error) {
                console.error("Error communicating with n8n:", error);
                // Exponential backoff logic would go here in a production app
                chatMessages.lastChild.querySelector('div').textContent = "Connection error. The booking service is temporarily unavailable. Please check the console for details.";
            } finally {
                chatInput.disabled = false;
                chatSendButton.disabled = false;
                chatInput.focus();
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // --- Core Binding Logic (Guaranteed to run after DOM is parsed) ---
        
        // Use a simple, immediate closure to bind handlers once the script loads
        document.addEventListener('DOMContentLoaded', () => {
            // Symptom Check button
            document.getElementById('checkButton').addEventListener('click', startCheck);

            // Open/Close Chatbot buttons
            document.getElementById('openChatButton').addEventListener('click', openChatbot);
            document.getElementById('closeChatButton').addEventListener('click', closeChatbot);

            // Send Chat Message
            document.getElementById('chatSendButton').addEventListener('click', sendMessage);

            // Allow sending message with Enter key
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    sendMessage();
                }
            });
        });

    </script>
</body>
</html>